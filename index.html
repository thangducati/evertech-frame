upload.addEventListener('change', (e) => {
  const reader = new FileReader();
  reader.onload = function(event) {
    const avatar = new Image();
    avatar.onload = function() {
      if (!frameLoaded) {
        alert("Khung chưa sẵn sàng!");
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Vị trí và kích thước khung avatar
      const x = 250;
      const y = 30;
      const w = 430;
      const h = 530;

      // Tính tỷ lệ phóng to nhưng vẫn giữ aspect ratio
      const scale = Math.max(w / avatar.width, h / avatar.height);
      const drawWidth = avatar.width * scale;
      const drawHeight = avatar.height * scale;

      // Căn giữa hình ảnh trong khung
      const offsetX = x + (w - drawWidth) / 2;
      const offsetY = y + (h - drawHeight) / 2;

      // Vẽ ảnh avatar (giữ tỷ lệ gốc)
      ctx.drawImage(avatar, offsetX, offsetY, drawWidth, drawHeight);

      // Vẽ lại khung lên trên avatar
      ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
    };
    avatar.crossOrigin = "anonymous";
    avatar.src = event.target.result;
  };
  reader.readAsDataURL(e.target.files[0]);
});
